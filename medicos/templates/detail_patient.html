{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<HTML:5>
<head>
    <title>Detalles del paciente</title>
    <script src="/static/js/formPacienteData.js"></script>
</head>
<body>
    <h2 class="display-1 text-center">Detalle del paciente</h2>


        {% if message %}
            <div class="alert alert-danger">{{ message }}</div>
        {% endif %}

        {% if form.errors %}
            <ul class="alert alert-danger">
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <li>{{ field }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
            </ul>
        {% endif %}


    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">


                <form method="post" class="card card-body mt-4 mb-4 shadow-sm"
                    x-data="formPacienteData({
                        initial: {
                            rut: '{{ form.rut.value|escapejs }}',
                            nombre: '{{ form.nombre.value|escapejs }}',
                            telefono: '{{ form.telefono.value|default_if_none:''|default:''|escapejs }}',
                            correo: '{{ form.correo.value|default_if_none:""|escapejs }}',
                            direccion: '{{ form.direccion.value|escapejs }}',
                            comentario: '{{ form.comentario.value|escapejs }}'
                        }
                    })"
                    x-init="init()"
                    @submit.prevent="handleSubmit($event)">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="id_rut">(*) RUT:</label>
                        <input type="text" name="rut" id="id_rut" x-model="rut" @input="validateRut()" :class="rutError ? 'border border-danger' : ''" class="form-control" required value="{{ form.rut.value|default_if_none:'' }}">
                        <div id="rut-error-msg" x-html="rutError" style="color:red; font-size:0.9em; margin-top:2px;"></div>
                    </div>

                    <div class="mb-3">
                        <label for="id_nombre">(*) Nombre:</label>
                        <input type="text" name="nombre" id="id_nombre" x-model="nombre" @input="validateNombre()" :class="nombreError ? 'border border-danger' : ''" class="form-control" required value="{{ form.nombre.value|default_if_none:'' }}">
                        <span x-show="nombreError" x-text="nombreError" style="color:red; font-size:0.9em; margin-left:10px;"></span>
                    </div>

                    <div class="mb-3">
                        <label for="sexo">(*) Sexo:</label>
                        <select name="sexo" id="sexo" class="form-control form-select">
                            <option value="M" {% if form.sexo.value == "M" %}selected{% endif %}>Mujer</option>
                            <option value="H" {% if form.sexo.value == "H" %}selected{% endif %}>Hombre</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label style="margin-left:10px;">(*) Fecha de nacimiento:</label>
                        <div class="d-flex flex-row gap-2" style="gap: 10px;">
                            <select name="dia" id="dia" class="form-control form-select" style="max-width: 90px;">
                                <option value="">Día</option>
                                {% for d in dias %}
                                <option value="{{ d }}"
                                    {% if request.POST.dia %}
                                        {% if request.POST.dia == d|stringformat:'s' %}selected{% endif %}
                                    {% else %}
                                        {% if form.instance.fecha_nacimiento and form.instance.fecha_nacimiento.day == d %}selected{% endif %}
                                    {% endif %}
                                >{{ d }}</option>
                                {% endfor %}
                            </select>
                            <select name="mes" id="mes" class="form-control form-select" style="max-width: 110px;">
                                <option value="">Mes</option>
                                {% for m in meses %}
                                <option value="{{ m }}"
                                    {% if request.POST.mes %}
                                        {% if request.POST.mes == m|stringformat:'s' %}selected{% endif %}
                                    {% else %}
                                        {% if form.instance.fecha_nacimiento and form.instance.fecha_nacimiento.month == m %}selected{% endif %}
                                    {% endif %}
                                >{{ m }}</option>
                                {% endfor %}
                            </select>
                            <select name="anio" id="anio" class="form-control form-select" style="max-width: 110px;">
                                <option value="">Año</option>
                                {% for y in anios %}
                                <option value="{{ y }}"
                                    {% if request.POST.anio %}
                                        {% if request.POST.anio == y|stringformat:'s' %}selected{% endif %}
                                    {% else %}
                                        {% if form.instance.fecha_nacimiento and form.instance.fecha_nacimiento.year == y %}selected{% endif %}
                                    {% endif %}
                                >{{ y }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="id_telefono">Teléfono(s):</label>
                        <input type="text" name="telefono" id="id_telefono" x-model="telefono" @input="validateTelefono()" :class="telefonoError ? 'border border-danger' : ''" class="form-control" value="{{ form.telefono.value|default_if_none:''|default:'' }}">
                                                <!-- El value ya está correcto, solo aseguramos el x-data inicial -->
                        <span x-show="telefonoError" x-text="telefonoError" style="color:red; font-size:0.9em; margin-left:10px;"></span>
                    </div>

                    <div class="mb-3">
                        <label for="id_correo">Correo electrónico:</label>
                        <input type="email" name="correo" id="id_correo" x-model="correo" @input="validateCorreo()" :class="correoError ? 'border border-danger' : ''" class="form-control" value="{{ form.correo.value|default_if_none:'' }}">
                        <span x-show="correoError" x-text="correoError" style="color:red; font-size:0.9em; margin-left:10px;"></span>
                    </div>

                    <div class="mb-3">
                        <label for="id_direccion">Dirección:</label>
                        <input type="text" name="direccion" id="id_direccion" x-model="direccion" @input="validateDireccion()" :class="direccionError ? 'border border-danger' : ''" class="form-control" value="{{ form.direccion.value|default_if_none:'' }}">
                        <span x-show="direccionError" x-text="direccionError" style="color:red; font-size:0.9em; margin-left:10px;"></span>
                    </div>

                    <div class="mb-3">
                        <label for="id_comentario">(*) Comentario:</label>
                        <textarea name="comentario" id="id_comentario" x-model="comentario"
                            @input="validateComentario()"
                            :class="comentarioError ? 'border border-danger' : ''"
                            class="form-control" required cols="40" rows="5"></textarea>
                        <span x-show="comentarioError" x-text="comentarioError" style="color:red; font-size:0.9em; margin-left:10px;"></span>
                    </div>

                        <div class="mb-3">
                            <label for="id_creado_en">(*) Fecha de Creación:</label>
                            <div class="d-flex flex-row gap-2" style="gap: 10px;">
                                <select name="dia_creado" id="dia_creado" class="form-control form-select" style="max-width: 90px;">
                                    <option value="">Día</option>
                                    {% for d in dias %}
                                    <option value="{{ d }}"
                                        {% if request.POST.dia_creado %}
                                            {% if request.POST.dia_creado == d|stringformat:'s' %}selected{% endif %}
                                        {% else %}
                                            {% if form.instance.creado_en and form.instance.creado_en.day == d %}selected{% endif %}
                                        {% endif %}
                                    >{{ d }}</option>
                                    {% endfor %}
                                </select>
                                <select name="mes_creado" id="mes_creado" class="form-control form-select" style="max-width: 110px;">
                                    <option value="">Mes</option>
                                    {% for m in meses %}
                                    <option value="{{ m }}"
                                        {% if request.POST.mes_creado %}
                                            {% if request.POST.mes_creado == m|stringformat:'s' %}selected{% endif %}
                                        {% else %}
                                            {% if form.instance.creado_en and form.instance.creado_en.month == m %}selected{% endif %}
                                        {% endif %}
                                    >{{ m }}</option>
                                    {% endfor %}
                                </select>
                                <select name="anio_creado" id="anio_creado" class="form-control form-select" style="max-width: 110px;">
                                    <option value="">Año</option>
                                    {% for y in anios %}
                                    <option value="{{ y }}"
                                        {% if request.POST.anio_creado %}
                                            {% if request.POST.anio_creado == y|stringformat:'s' %}selected{% endif %}
                                        {% else %}
                                            {% if form.instance.creado_en and form.instance.creado_en.year == y %}selected{% endif %}
                                        {% endif %}
                                    >{{ y }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                    {% if form.estado %}
                    <label for="estado">(*) Estado:</label>
                    <select name="estado" id="estado" class="form-control form-select">
                        <option value="EN_ESPERA" {% if form.estado.value == "EN_ESPERA" %}selected{% endif %}>En espera</option>
                        <option value="OPERADO" {% if form.estado.value == "OPERADO" %}selected{% endif %}>Operado</option>
                    </select>
                    {% endif %}

                    {% if patient.estado == 'OPERADO' and form.instance.fecha_cambio_estado %}
                    <div class="mb-3">
                        <label><strong>Fecha de cambio de estado:</strong></label>
                        <span>{{ form.instance.fecha_cambio_estado|date:'Y-m-d H:i' }}</span>
                    </div>
                    {% endif %}

                    {% if form.creado_por %}
                    <div class="mb-3">
                        <label><strong>Creado por:</strong></label>
                        <span>
                            {{ form.creado_por.value|default:"- Sin información -" }}
                        </span>
                    </div>
                    {% endif %}

                    {% if form.actualizado_por %}
                    <div class="mb-3">
                        <label><strong>Actualizado por:</strong></label>
                        <span>
                            {% if form.instance.actualizado_por %}
                                {{ form.instance.actualizado_por.get_full_name|default:form.instance.actualizado_por.username }}
                            {% else %}
                                - Sin información -
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}

                    <button type="submit" class="btn btn-primary">Actualizar paciente</button>
                </form>

                <h3 class="display-6 text-center">Historial de Puntajes</h3>
                <div class="text-center mb-4">
                    <div class="container">
                        <div class="row">
                            <div class="col-md-10 offset-md-1">
                                <table class="table table-striped" cellpadding="5" cellspacing="0">
                                    <thead>
                                        <tr style="background:#343a40; color:#fff;">
                                            <th>Rango de tiempo</th>
                                            <th>Puntaje inicial</th>
                                            <th>Puntaje por tiempo</th>
                                            <th>Puntaje total</th>
                                            <th>Fecha</th>
                                            <th>Motivo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for h in historial_puntajes %}
                                        <tr>
                                            <td>{% if h.rango_tiempo %}{{ h.rango_tiempo.descripcion }}{% else %}-{% endif %}</td>
                                            <td>{{ h.puntaje_inicial }}</td>
                                            <td>{{ h.puntaje_tiempo }}</td>
                                            <td>{{ h.puntaje_total }}</td>
                                            <td>{{ h.fecha_cambio|date:"Y-m-d H:i" }}</td>
                                            <td>{{ h.get_motivo_cambio_display }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="6" class="text-center text-muted mt-4">Sin historial de puntajes</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <form action="{% url 'delete_patient' patient.id %}" method="post" class="mt-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger w-100" onclick="return confirm('¿Seguro que deseas desestimar este ingreso?');">Desestimar ingreso</button>
                </form>

            </div>
        </div>
    </div>

    {% endblock %}

</body>
</HTML:5>